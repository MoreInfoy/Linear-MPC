//
// Created by nimapng on 6/7/21.
//

#include "LinearMPC.h"
#include "Timer.h"

int main() {
    MPC::Timer timer;
    LinearMPC linearMpc;
    double st = timer.getMs();
    MPC::Mat_Ak Ak;
    MPC::Mat_Bk Bk;
    Ak << 1.0, 0.0494, 0, 0.9753;
    Bk << 0.0012, 0.0494;
    linearMpc.setAkBk(Ak, Bk);

    MPC::Mat_Ccx Ccx;
    Ccx << 1.0, 0;
    MPC::Vec_bcx cxlb, cxub;
    cxlb << -3.0;
    cxub << 3.0;
    linearMpc.setStateConstraints(Ccx, cxlb, cxub);

    MPC::Mat_Ccu Ccu;
    Ccu << 0.5;
    MPC::Vec_bcu culb, cuub;
    culb << -3.0;
    cuub << 3.0;
    linearMpc.setInputConstraints(Ccu, culb, cuub);

    MPC::Vec_U_Bounds lb, ub;
    lb << -5.5;
    ub << 4.6;
    linearMpc.setInputBounds(lb, ub);

    MPC::Mat_Qx Q;
    Q << 1000.0, 0, 0, 10.0;
    MPC::Mat_Ru R;
    R << 0.1;
    linearMpc.setWeightMatrix(Q, R);

    MPC::Vec x0, x_ref;
    x0.resize(2);
    x0 << 2.0, 0.0;
    x_ref.resize(HORIZON * Ak_ROWS);
    x_ref.setZero();
    for (int i = 0; i < HORIZON; i++) {
        if(i%2==0)
        {
            x_ref(i) = -2.0;
        }
        else
        {
            x_ref(i) = 0.0;
        }
    }

    linearMpc.setInitialStateAndRef(x0, x_ref);

    double time_formulation = timer.getMs() - st;

    for (int i = 0; i < 10; i++) {
        st = timer.getMs();

//        std::cout << "sol: " << linearMpc.getSolution().transpose() << std::endl;

        linearMpc.getSolution();
        double et = timer.getMs();

        printf("solve time: %f, formulation time: %f\n", et - st, time_formulation);
    }

    linearMpc.outputAllDataToFile("data.txt");

    return 0;

}
//-5.5        -5.5        -5.5        -5.5     -5.2018     -2.5802    -1.00764  -0.0746401    0.468927    0.775836    0.939375     1.01649      1.0419      1.0368     1.01406      0.9815    0.943861    0.903985    0.863572    0.823616    0.784689    0.747102    0.711011    0.676477    0.643506    0.612074    0.582134    0.553633    0.526511    0.500709    0.476165     0.45282    0.430618    0.409503    0.389423    0.370326    0.352166    0.334896    0.318473    0.302856    0.288004     0.27388    0.260449    0.247677    0.235531    0.223981    0.212997    0.202551    0.192618    0.183172     0.17419    0.165648    0.157524    0.149799    0.142453    0.135467    0.128824    0.122507    0.116499    0.110786    0.105353    0.100186   0.0952733   0.0906012   0.0861581    0.081933    0.077915   0.0740941   0.0704605   0.0670052   0.0637192   0.0605945   0.0576229   0.0547971   0.0521099   0.0495544   0.0471243   0.0448134   0.0426157   0.0405259   0.0385385   0.0366486   0.0348513   0.0331422    0.031517   0.0299714   0.0285016   0.0271039   0.0257747   0.0245107   0.0233087   0.0221657   0.0210787    0.020045    0.019062   0.0181272   0.0172382   0.0163929    0.015589   0.0148245   0.0140975   0.0134062   0.0127488   0.0121236    0.011529   0.0109636    0.010426   0.0099147  0.00942849  0.00896612  0.00852643   0.0081083  0.00771067  0.00733254  0.00697296  0.00663101  0.00630582  0.00599659  0.00570252  0.00542287  0.00515694  0.00490404  0.00466355  0.00443485  0.00421737  0.00401056  0.00381388  0.00362685  0.00344899  0.00327986  0.00311902  0.00296606  0.00282061  0.00268229  0.00255076  0.00242567  0.00230672   0.0021936  0.00208603  0.00198374  0.00188646  0.00179395  0.00170598  0.00162232  0.00154277  0.00146712  0.00139517  0.00132676   0.0012617  0.00119983    0.001141  0.00108505  0.00103185 0.000981253 0.000933139 0.000887386 0.000843877 0.000802501 0.000763156  0.00072574 0.000690159 0.000656324 0.000624149 0.000593552 0.000564456 0.000536787 0.000510476 0.000485456 0.000461664 0.000439039 0.000417524 0.000397065 0.000377611 0.000359111  0.00034152 0.000324792 0.000308885  0.00029376 0.000279378 0.000265702 0.000252698 0.000240333 0.000228576 0.000217397 0.000206767 0.000196661 0.000187052 0.000177916  0.00016923 0.000160971  0.00015312 0.000145657 0.000138561 0.000131816 0.000125404  0.00011931 0.000113517 0.000108011 0.000102778 9.78056e-05 9.30803e-05 8.85903e-05 8.43243e-05 8.02716e-05 7.64219e-05 7.27654e-05  6.9293e-05 6.59958e-05 6.28655e-05 5.98942e-05 5.70743e-05 5.43988e-05 5.18608e-05 4.94541e-05 4.71723e-05 4.50099e-05 4.29613e-05 4.10213e-05 3.91851e-05 3.74479e-05 3.58055e-05 3.42536e-05 3.27884e-05  3.1406e-05 3.01031e-05 2.88763e-05 2.77224e-05 2.66387e-05 2.56223e-05 2.46706e-05 2.37812e-05 2.29516e-05 2.21798e-05 2.14635e-05 2.08005e-05 2.01886e-05 1.96253e-05 1.91074e-05 1.86311e-05 1.81909e-05 1.77786e-05 1.73816e-05 1.69803e-05 1.65426e-05  1.6017e-05 1.53198e-05 1.43139e-05 1.27758e-05 1.03398e-05 6.40755e-06
//-5.5        -5.5        -5.5        -5.5    -4.98689    -2.38423   -0.826005   0.0954427    0.629208    0.927462     1.08314     1.15299     1.17161      1.1601      1.1313       1.093      1.0499     1.00484    0.959499    0.914856    0.871471    0.829644    0.789519    0.751149    0.714529    0.679626    0.646385    0.614744    0.584636    0.555993    0.528747    0.502833    0.478187    0.454747    0.432456    0.411256    0.391096    0.371924    0.353691    0.336352    0.319864    0.304183    0.289271     0.27509    0.261605     0.24878    0.236584    0.224986    0.213957    0.203468    0.193493    0.184008    0.174987    0.166409    0.158251    0.150493    0.143115      0.1361    0.129428    0.123083    0.117049    0.111311    0.105854    0.100665   0.0957298   0.0910369    0.086574   0.0823299   0.0782939   0.0744557   0.0708057   0.0673346   0.0640336   0.0608945   0.0579093   0.0550704   0.0523707   0.0498034   0.0473619   0.0450401   0.0428321   0.0407323   0.0387355   0.0368366   0.0350307   0.0333134   0.0316803   0.0301273   0.0286503   0.0272458   0.0259102     0.02464    0.023432   0.0222833    0.021191   0.0201521   0.0191642   0.0182247   0.0173313   0.0164817   0.0156737   0.0149053   0.0141746   0.0134797   0.0128189   0.0121905   0.0115929   0.0110246   0.0104841  0.00997016   0.0094814  0.00901659  0.00857458  0.00815423  0.00775448  0.00737434  0.00701283  0.00666904  0.00634211   0.0060312  0.00573554  0.00545436  0.00518698   0.0049327  0.00469089  0.00446093  0.00424224  0.00403428  0.00383651  0.00364843  0.00346958  0.00329949  0.00313774  0.00298392  0.00283765  0.00269854  0.00256625  0.00244045  0.00232081  0.00220704  0.00209885  0.00199596  0.00189812  0.00180507  0.00171659  0.00163244  0.00155242  0.00147632  0.00140395  0.00133513  0.00126968  0.00120744  0.00114826  0.00109197  0.00103845 0.000987547 0.000939141  0.00089311 0.000849335 0.000807706 0.000768119 0.000730473 0.000694672 0.000660628 0.000628252 0.000597465 0.000568187 0.000540345 0.000513869 0.000488691 0.000464749 0.000441981 0.000420329  0.00039974 0.000380161 0.000361543 0.000343839 0.000327003 0.000310994 0.000295771 0.000281295  0.00026753 0.000254441 0.000241995 0.000230161 0.000218908 0.000208209 0.000198036 0.000188363 0.000179166 0.000170422 0.000162109 0.000154205 0.000146691 0.000139548 0.000132757 0.000126302 0.000120166 0.000114334 0.000108791 0.000103522 9.85153e-05 9.37575e-05 8.92366e-05 8.49412e-05 8.08605e-05 7.69841e-05 7.33022e-05 6.98057e-05 6.64855e-05 6.33333e-05 6.03412e-05 5.75015e-05 5.48072e-05 5.22514e-05 4.98277e-05 4.75298e-05 4.53521e-05  4.3289e-05 4.13352e-05  3.9486e-05 3.77365e-05 3.60824e-05 3.45194e-05 3.30437e-05 3.16515e-05 3.03392e-05 2.91036e-05 2.79415e-05 2.68499e-05 2.58261e-05 2.48673e-05 2.39709e-05 2.31346e-05 2.23558e-05  2.1632e-05 2.09602e-05 2.03373e-05  1.9759e-05 1.92195e-05 1.87104e-05 1.82189e-05 1.77248e-05 1.71958e-05 1.65801e-05 1.57932e-05 1.46976e-05 1.30688e-05 1.05398e-05 6.51067e-06
